<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SEC EDGAR Viewer</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@300;400;500;600&display=swap');

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root {
  --bg-0: #0a0a0a;
  --bg-1: #0f0f0f;
  --bg-2: #161616;
  --bg-3: #1c1c1c;
  --bg-4: #242424;
  --border: #2a2a2a;
  --border-bright: #3a3a3a;
  --text-0: #999;
  --text-1: #b0b0b0;
  --text-2: #d4d4d4;
  --text-3: #e8e8e8;
  --green: #00d26a;
  --green-dim: #00a854;
  --green-bg: rgba(0,210,106,0.06);
  --amber: #f0a830;
  --amber-dim: #c08820;
  --red: #e84040;
  --blue: #4a9eff;
  --cyan: #00c8c8;
  --mono: 'JetBrains Mono', 'IBM Plex Mono', 'Consolas', monospace;
}

html { font-size: 13px; }
body {
  font-family: var(--mono);
  background: var(--bg-0);
  color: var(--text-1);
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* ── TOP BAR ────────────────────────────────────────────────── */
.topbar {
  height: 36px;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 16px;
  flex-shrink: 0;
  gap: 12px;
}
.topbar-brand {
  color: var(--green);
  font-weight: 600;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
}
.topbar-sep {
  width: 1px;
  height: 16px;
  background: var(--border);
}
.topbar-info {
  font-size: 11px;
  color: var(--text-0);
  letter-spacing: 0.5px;
}
.topbar-right {
  margin-left: auto;
  font-size: 10px;
  color: var(--text-0);
  letter-spacing: 0.5px;
}

/* ── LAYOUT ─────────────────────────────────────────────────── */
.layout {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* ── SIDEBAR ────────────────────────────────────────────────── */
.sidebar {
  width: 180px;
  background: var(--bg-1);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}
.sidebar-header {
  padding: 10px 14px 8px;
  font-size: 10px;
  color: var(--text-0);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  border-bottom: 1px solid var(--border);
}
.sidebar-list {
  flex: 1;
  overflow-y: auto;
  padding: 4px 0;
}
.ticker-item {
  padding: 7px 14px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-1);
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: background 0.1s, color 0.1s;
  border-left: 2px solid transparent;
}
.ticker-item:hover {
  background: var(--bg-3);
  color: var(--text-2);
}
.ticker-item.active {
  background: var(--green-bg);
  color: var(--green);
  border-left-color: var(--green);
}
.ticker-item .dot {
  width: 5px;
  height: 5px;
  background: var(--green-dim);
  display: inline-block;
}
.sidebar-empty {
  padding: 20px 14px;
  font-size: 11px;
  color: var(--text-0);
  font-style: italic;
}

/* ── MAIN ───────────────────────────────────────────────────── */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ── TABS ───────────────────────────────────────────────────── */
.tab-bar {
  display: flex;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.tab {
  padding: 9px 20px;
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-0);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: color 0.15s, border-color 0.15s;
  font-family: var(--mono);
}
.tab:hover { color: var(--text-2); }
.tab.active {
  color: var(--green);
  border-bottom-color: var(--green);
}

/* ── TOOLBAR ────────────────────────────────────────────────── */
.toolbar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--bg-2);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  flex-wrap: wrap;
}
.toolbar select,
.toolbar input {
  font-family: var(--mono);
  font-size: 11px;
  background: var(--bg-0);
  color: var(--text-2);
  border: 1px solid var(--border);
  padding: 4px 8px;
  outline: none;
}
.toolbar select:focus,
.toolbar input:focus {
  border-color: var(--green-dim);
}
.toolbar select { min-width: 100px; cursor: pointer; }
.toolbar input[type="text"] { width: 200px; }
.toolbar-label {
  font-size: 10px;
  color: var(--text-0);
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.toolbar-count {
  margin-left: auto;
  font-size: 10px;
  color: var(--text-0);
}

/* ── CONTENT ────────────────────────────────────────────────── */
.content {
  flex: 1;
  overflow-y: auto;
  padding: 0;
}

/* ── EMPTY STATE ────────────────────────────────────────────── */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-0);
  gap: 8px;
}
.empty-state-icon {
  font-size: 32px;
  color: var(--border-bright);
  font-weight: 300;
  line-height: 1;
}
.empty-state-text {
  font-size: 12px;
  letter-spacing: 0.5px;
}

/* ── COMPANY CARD ───────────────────────────────────────────── */
.company-card {
  padding: 24px;
  max-width: 720px;
}
.company-name {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-3);
  margin-bottom: 4px;
}
.company-ticker {
  font-size: 13px;
  color: var(--green);
  font-weight: 500;
  letter-spacing: 1px;
  margin-bottom: 20px;
}
.company-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1px;
  background: var(--border);
  border: 1px solid var(--border);
}
.company-field {
  padding: 10px 14px;
  background: var(--bg-1);
}
.company-field-label {
  font-size: 10px;
  color: var(--text-0);
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-bottom: 3px;
}
.company-field-value {
  font-size: 12px;
  color: var(--text-2);
  font-weight: 500;
}

/* ── TABLE ──────────────────────────────────────────────────── */
.table-wrap { overflow-x: auto; }
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 11px;
}
thead {
  position: sticky;
  top: 0;
  z-index: 2;
}
th {
  background: var(--bg-3);
  color: var(--text-0);
  font-weight: 500;
  font-size: 10px;
  letter-spacing: 0.8px;
  text-transform: uppercase;
  text-align: left;
  padding: 7px 10px;
  border-bottom: 1px solid var(--border-bright);
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
  transition: color 0.1s;
}
th:hover { color: var(--text-2); }
th.sorted { color: var(--green); }
th .sort-arrow {
  font-size: 9px;
  margin-left: 3px;
  opacity: 0.5;
}
th.sorted .sort-arrow { opacity: 1; }
td {
  padding: 5px 10px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
  color: var(--text-1);
  max-width: 300px;
  overflow: hidden;
  text-overflow: ellipsis;
}
tr:hover td {
  background: var(--bg-2);
}
td.num {
  text-align: right;
  font-variant-numeric: tabular-nums;
}
td a {
  color: var(--blue);
  text-decoration: none;
}
td a:hover { text-decoration: underline; }

.badge {
  display: inline-block;
  padding: 1px 6px;
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.badge-green {
  color: var(--green);
  background: rgba(0,210,106,0.1);
  border: 1px solid rgba(0,210,106,0.2);
}
.badge-amber {
  color: var(--amber);
  background: rgba(240,168,48,0.08);
  border: 1px solid rgba(240,168,48,0.15);
}
.badge-dim {
  color: var(--text-0);
  background: var(--bg-3);
  border: 1px solid var(--border);
}

.val-positive { color: var(--green); }
.val-negative { color: var(--red); }
.val-currency { color: var(--text-2); font-weight: 500; }

/* ── PAGINATION ─────────────────────────────────────────────── */
.pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 10px 16px;
  border-top: 1px solid var(--border);
  background: var(--bg-1);
  flex-shrink: 0;
}
.page-btn {
  font-family: var(--mono);
  font-size: 11px;
  padding: 3px 10px;
  background: var(--bg-3);
  color: var(--text-1);
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.1s;
}
.page-btn:hover:not(:disabled) {
  background: var(--bg-4);
  color: var(--text-2);
  border-color: var(--border-bright);
}
.page-btn:disabled {
  opacity: 0.3;
  cursor: default;
}
.page-btn.active {
  color: var(--green);
  border-color: var(--green-dim);
  background: var(--green-bg);
}
.page-info {
  font-size: 10px;
  color: var(--text-0);
  padding: 0 8px;
}

/* ── SCROLLBAR ──────────────────────────────────────────────── */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-0); }
::-webkit-scrollbar-thumb { background: var(--border-bright); }
::-webkit-scrollbar-thumb:hover { background: #444; }

/* ── LOADING ────────────────────────────────────────────────── */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-0);
  font-size: 12px;
  gap: 8px;
}
.loading-dot {
  width: 4px; height: 4px;
  background: var(--green-dim);
  animation: blink 1s infinite;
}
.loading-dot:nth-child(2) { animation-delay: 0.2s; }
.loading-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink {
  0%,100% { opacity: 0.2; }
  50% { opacity: 1; }
}

/* ── SCANLINE TEXTURE ───────────────────────────────────────── */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  pointer-events: none;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0,0,0,0.03) 2px,
    rgba(0,0,0,0.03) 4px
  );
  z-index: 9999;
}
</style>
</head>
<body>

<div class="topbar">
  <span class="topbar-brand">SEC EDGAR</span>
  <span class="topbar-sep"></span>
  <span class="topbar-info" id="topbar-info">Financial Data Viewer</span>
  <span class="topbar-right" id="topbar-time"></span>
</div>

<div class="layout">
  <div class="sidebar">
    <div class="sidebar-header">Tickers</div>
    <div class="sidebar-list" id="sidebar-list"></div>
  </div>

  <div class="main">
    <div class="tab-bar" id="tab-bar" style="display:none">
      <div class="tab active" data-tab="company">Company</div>
      <div class="tab" data-tab="filings">Filings</div>
      <div class="tab" data-tab="facts">Facts</div>
    </div>

    <div class="toolbar" id="toolbar" style="display:none"></div>

    <div class="content" id="content">
      <div class="empty-state">
        <div class="empty-state-icon">&gt;_</div>
        <div class="empty-state-text">Select a ticker to view data</div>
      </div>
    </div>

    <div class="pagination" id="pagination" style="display:none"></div>
  </div>
</div>

<script>
const PAGE_SIZE = 50;

let state = {
  tickers: [],
  activeTicker: null,
  data: null,
  activeTab: 'company',
  // filings
  filingsSort: { col: 'filingDate', dir: -1 },
  filingsFormFilter: '',
  filingsSearch: '',
  filingsPage: 0,
  // facts
  factsSort: { col: 'end', dir: -1 },
  factsTagFilter: '',
  factsFpFilter: '',
  factsFormFilter: '',
  factsSearch: '',
  factsPage: 0,
};

// ── INIT ───────────────────────────────────────────────────────
async function init() {
  updateClock();
  setInterval(updateClock, 1000);

  const res = await fetch('/api/files');
  state.tickers = await res.json();
  renderSidebar();
  setupTabs();
}

function updateClock() {
  const now = new Date();
  document.getElementById('topbar-time').textContent =
    now.toLocaleTimeString('en-US', { hour12: false }) + ' EST';
}

// ── SIDEBAR ────────────────────────────────────────────────────
function renderSidebar() {
  const el = document.getElementById('sidebar-list');
  if (!state.tickers.length) {
    el.innerHTML = '<div class="sidebar-empty">No data files in output/</div>';
    return;
  }
  el.innerHTML = state.tickers.map(t =>
    `<div class="ticker-item${t === state.activeTicker ? ' active' : ''}" data-ticker="${t}">
      <span class="dot"></span>${t}
    </div>`
  ).join('');
  el.querySelectorAll('.ticker-item').forEach(item => {
    item.addEventListener('click', () => loadTicker(item.dataset.ticker));
  });
}

// ── LOAD TICKER ────────────────────────────────────────────────
async function loadTicker(ticker) {
  state.activeTicker = ticker;
  state.filingsPage = 0;
  state.factsPage = 0;
  state.filingsFormFilter = '';
  state.filingsSearch = '';
  state.factsTagFilter = '';
  state.factsFpFilter = '';
  state.factsFormFilter = '';
  state.factsSearch = '';

  renderSidebar();

  const content = document.getElementById('content');
  content.innerHTML = '<div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div><span>Loading...</span></div>';

  document.getElementById('tab-bar').style.display = 'flex';

  const res = await fetch(`/api/data/${ticker}`);
  state.data = await res.json();

  const co = state.data.company || {};
  document.getElementById('topbar-info').textContent =
    `${co.name || ticker} — CIK ${state.data.cik || ''}`;

  renderTab();
}

// ── TABS ───────────────────────────────────────────────────────
function setupTabs() {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      if (!state.data) return;
      state.activeTab = tab.dataset.tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      renderTab();
    });
  });
}

function renderTab() {
  if (!state.data) return;
  const tab = state.activeTab;
  if (tab === 'company') renderCompany();
  else if (tab === 'filings') renderFilings();
  else if (tab === 'facts') renderFacts();
}

// ── COMPANY TAB ────────────────────────────────────────────────
function renderCompany() {
  document.getElementById('toolbar').style.display = 'none';
  document.getElementById('pagination').style.display = 'none';

  const co = state.data.company || {};
  const d = state.data;

  const fields = [
    ['CIK', d.cik],
    ['Entity Type', co.entityType],
    ['SIC Code', co.sic],
    ['SIC Description', co.sicDescription],
    ['State of Inc.', co.stateOfIncorporation],
    ['Fiscal Year End', co.fiscalYearEnd ? formatFYE(co.fiscalYearEnd) : '—'],
    ['Exchanges', (co.exchanges || []).join(', ') || '—'],
    ['Tickers', (co.tickers || []).join(', ') || '—'],
  ];

  const filingCount = (state.data.filings || []).length;
  const factCount = (state.data.facts || []).length;

  document.getElementById('content').innerHTML = `
    <div class="company-card">
      <div class="company-name">${esc(co.name || state.activeTicker)}</div>
      <div class="company-ticker">${esc(state.activeTicker)} &nbsp;<span style="color:var(--text-0);font-size:11px">${filingCount.toLocaleString()} filings &middot; ${factCount.toLocaleString()} facts</span></div>
      <div class="company-grid">
        ${fields.map(([label, val]) => `
          <div class="company-field">
            <div class="company-field-label">${esc(label)}</div>
            <div class="company-field-value">${esc(val || '—')}</div>
          </div>
        `).join('')}
      </div>
    </div>`;
}

function formatFYE(code) {
  if (!code || code.length !== 4) return code;
  const months = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const m = parseInt(code.substring(0, 2), 10);
  const d = parseInt(code.substring(2, 4), 10);
  return `${months[m] || code.substring(0,2)} ${d}`;
}

// ── FILINGS TAB ────────────────────────────────────────────────
function renderFilings() {
  const toolbar = document.getElementById('toolbar');
  toolbar.style.display = 'flex';

  const filings = state.data.filings || [];
  const forms = [...new Set(filings.map(f => f.form))].sort();

  toolbar.innerHTML = `
    <span class="toolbar-label">Form</span>
    <select id="filings-form-filter">
      <option value="">All</option>
      ${forms.map(f => `<option value="${esc(f)}"${f === state.filingsFormFilter ? ' selected' : ''}>${esc(f)}</option>`).join('')}
    </select>
    <span class="toolbar-label">Search</span>
    <input type="text" id="filings-search" placeholder="Filter rows..." value="${esc(state.filingsSearch)}">
    <span class="toolbar-count" id="filings-count"></span>
  `;

  document.getElementById('filings-form-filter').addEventListener('change', e => {
    state.filingsFormFilter = e.target.value;
    state.filingsPage = 0;
    renderFilingsTable();
  });
  document.getElementById('filings-search').addEventListener('input', e => {
    state.filingsSearch = e.target.value;
    state.filingsPage = 0;
    renderFilingsTable();
  });

  renderFilingsTable();
}

function getFilteredFilings() {
  let rows = state.data.filings || [];
  if (state.filingsFormFilter) rows = rows.filter(r => r.form === state.filingsFormFilter);
  if (state.filingsSearch) {
    const q = state.filingsSearch.toLowerCase();
    rows = rows.filter(r =>
      (r.form || '').toLowerCase().includes(q) ||
      (r.filingDate || '').includes(q) ||
      (r.accessionNumber || '').toLowerCase().includes(q) ||
      (r.primaryDocDescription || '').toLowerCase().includes(q)
    );
  }
  const s = state.filingsSort;
  rows = [...rows].sort((a, b) => {
    let va = a[s.col] ?? '', vb = b[s.col] ?? '';
    if (typeof va === 'number' && typeof vb === 'number') return (va - vb) * s.dir;
    return String(va).localeCompare(String(vb)) * s.dir;
  });
  return rows;
}

function renderFilingsTable() {
  const rows = getFilteredFilings();
  const totalPages = Math.max(1, Math.ceil(rows.length / PAGE_SIZE));
  state.filingsPage = Math.min(state.filingsPage, totalPages - 1);
  const page = rows.slice(state.filingsPage * PAGE_SIZE, (state.filingsPage + 1) * PAGE_SIZE);

  document.getElementById('filings-count').textContent = `${rows.length} rows`;

  const cols = [
    { key: 'form', label: 'Form' },
    { key: 'filingDate', label: 'Filed' },
    { key: 'reportDate', label: 'Report' },
    { key: 'accessionNumber', label: 'Accession No.' },
    { key: 'primaryDocDescription', label: 'Description' },
    { key: 'isKeyForm', label: 'Key' },
  ];

  const s = state.filingsSort;
  const content = document.getElementById('content');
  content.innerHTML = `<div class="table-wrap"><table>
    <thead><tr>${cols.map(c =>
      `<th class="${s.col === c.key ? 'sorted' : ''}" data-col="${c.key}">${c.label}<span class="sort-arrow">${s.col === c.key ? (s.dir === 1 ? '▲' : '▼') : ''}</span></th>`
    ).join('')}</tr></thead>
    <tbody>${page.map(r => {
      const accnUrl = r.accessionNumber
        ? `https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&CIK=${state.data.cik}&type=&dateb=&owner=include&count=40&search_text=&action=getcompany`
        : '';
      const accnClean = (r.accessionNumber || '').replace(/-/g, '');
      const edgarUrl = r.accessionNumber
        ? `https://www.sec.gov/Archives/edgar/data/${parseInt(state.data.cik)}/` + accnClean + '/' + (r.primaryDocument || '')
        : '';
      const formBadge = r.isKeyForm
        ? `<span class="badge badge-green">${esc(r.form)}</span>`
        : esc(r.form || '');
      return `<tr>
        <td>${formBadge}</td>
        <td>${esc(r.filingDate || '')}</td>
        <td>${esc(r.reportDate || '')}</td>
        <td>${r.accessionNumber ? `<a href="${edgarUrl}" target="_blank" rel="noopener">${esc(r.accessionNumber)}</a>` : ''}</td>
        <td>${esc(r.primaryDocDescription || '')}</td>
        <td>${r.isKeyForm ? '<span class="badge badge-green">KEY</span>' : ''}</td>
      </tr>`;
    }).join('')}</tbody>
  </table></div>`;

  content.querySelectorAll('th').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.col;
      if (state.filingsSort.col === col) state.filingsSort.dir *= -1;
      else state.filingsSort = { col, dir: 1 };
      renderFilingsTable();
    });
  });

  renderPagination(rows.length, state.filingsPage, p => {
    state.filingsPage = p;
    renderFilingsTable();
  });
}

// ── FACTS TAB ──────────────────────────────────────────────────
function renderFacts() {
  const toolbar = document.getElementById('toolbar');
  toolbar.style.display = 'flex';

  const facts = state.data.facts || [];
  const tags = [...new Set(facts.map(f => f.canonical_tag || f.tag))].sort();
  const fps = [...new Set(facts.map(f => f.fp).filter(Boolean))].sort();
  const forms = [...new Set(facts.map(f => f.form).filter(Boolean))].sort();

  toolbar.innerHTML = `
    <span class="toolbar-label">Tag</span>
    <select id="facts-tag-filter">
      <option value="">All</option>
      ${tags.map(t => `<option value="${esc(t)}"${t === state.factsTagFilter ? ' selected' : ''}>${esc(t)}</option>`).join('')}
    </select>
    <span class="toolbar-label">Period</span>
    <select id="facts-fp-filter">
      <option value="">All</option>
      ${fps.map(f => `<option value="${esc(f)}"${f === state.factsFpFilter ? ' selected' : ''}>${esc(f)}</option>`).join('')}
    </select>
    <span class="toolbar-label">Form</span>
    <select id="facts-form-filter">
      <option value="">All</option>
      ${forms.map(f => `<option value="${esc(f)}"${f === state.factsFormFilter ? ' selected' : ''}>${esc(f)}</option>`).join('')}
    </select>
    <span class="toolbar-label">Search</span>
    <input type="text" id="facts-search" placeholder="Filter rows..." value="${esc(state.factsSearch)}">
    <span class="toolbar-count" id="facts-count"></span>
  `;

  const bind = (id, key) => {
    document.getElementById(id).addEventListener(id.includes('search') ? 'input' : 'change', e => {
      state[key] = e.target.value;
      state.factsPage = 0;
      renderFactsTable();
    });
  };
  bind('facts-tag-filter', 'factsTagFilter');
  bind('facts-fp-filter', 'factsFpFilter');
  bind('facts-form-filter', 'factsFormFilter');
  bind('facts-search', 'factsSearch');

  renderFactsTable();
}

function getFilteredFacts() {
  let rows = state.data.facts || [];
  if (state.factsTagFilter) rows = rows.filter(r => (r.canonical_tag || r.tag) === state.factsTagFilter);
  if (state.factsFpFilter) rows = rows.filter(r => r.fp === state.factsFpFilter);
  if (state.factsFormFilter) rows = rows.filter(r => r.form === state.factsFormFilter);
  if (state.factsSearch) {
    const q = state.factsSearch.toLowerCase();
    rows = rows.filter(r =>
      (r.tag || '').toLowerCase().includes(q) ||
      (r.label || '').toLowerCase().includes(q) ||
      (r.canonical_tag || '').toLowerCase().includes(q) ||
      String(r.value || '').includes(q)
    );
  }
  const s = state.factsSort;
  rows = [...rows].sort((a, b) => {
    let va = a[s.col] ?? '', vb = b[s.col] ?? '';
    if (s.col === 'value') {
      va = Number(va) || 0; vb = Number(vb) || 0;
      return (va - vb) * s.dir;
    }
    if (s.col === 'fy') {
      va = Number(va) || 0; vb = Number(vb) || 0;
      return (va - vb) * s.dir;
    }
    return String(va).localeCompare(String(vb)) * s.dir;
  });
  return rows;
}

function renderFactsTable() {
  const rows = getFilteredFacts();
  const totalPages = Math.max(1, Math.ceil(rows.length / PAGE_SIZE));
  state.factsPage = Math.min(state.factsPage, totalPages - 1);
  const page = rows.slice(state.factsPage * PAGE_SIZE, (state.factsPage + 1) * PAGE_SIZE);

  document.getElementById('facts-count').textContent = `${rows.length} rows`;

  const cols = [
    { key: 'canonical_tag', label: 'Tag' },
    { key: 'label', label: 'Label' },
    { key: 'value', label: 'Value' },
    { key: 'unit', label: 'Unit' },
    { key: 'end', label: 'Period End' },
    { key: 'fy', label: 'FY' },
    { key: 'fp', label: 'FP' },
    { key: 'form', label: 'Form' },
    { key: 'filed', label: 'Filed' },
  ];

  const s = state.factsSort;
  const content = document.getElementById('content');
  content.innerHTML = `<div class="table-wrap"><table>
    <thead><tr>${cols.map(c =>
      `<th class="${s.col === c.key ? 'sorted' : ''}" data-col="${c.key}">${c.label}<span class="sort-arrow">${s.col === c.key ? (s.dir === 1 ? '▲' : '▼') : ''}</span></th>`
    ).join('')}</tr></thead>
    <tbody>${page.map(r => {
      const valStr = formatValue(r.value, r.unit);
      const valClass = r.unit === 'USD' ? 'val-currency' : '';
      return `<tr>
        <td><span class="badge badge-dim">${esc(r.canonical_tag || r.tag || '')}</span></td>
        <td>${esc(r.label || '')}</td>
        <td class="num ${valClass}">${valStr}</td>
        <td>${esc(r.unit || '')}</td>
        <td>${esc(r.end || '')}</td>
        <td class="num">${r.fy || ''}</td>
        <td>${fpBadge(r.fp)}</td>
        <td>${esc(r.form || '')}</td>
        <td>${esc(r.filed || '')}</td>
      </tr>`;
    }).join('')}</tbody>
  </table></div>`;

  content.querySelectorAll('th').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.col;
      if (state.factsSort.col === col) state.factsSort.dir *= -1;
      else state.factsSort = { col, dir: 1 };
      renderFactsTable();
    });
  });

  renderPagination(rows.length, state.factsPage, p => {
    state.factsPage = p;
    renderFactsTable();
  });
}

// ── VALUE FORMATTING ───────────────────────────────────────────
function formatValue(val, unit) {
  if (val == null || val === '') return '—';
  const n = Number(val);
  if (isNaN(n)) return esc(String(val));

  if (unit === 'USD' || unit === 'USD/shares') {
    const prefix = unit === 'USD' ? '$' : '';
    const abs = Math.abs(n);
    let formatted;
    if (abs >= 1e12) formatted = prefix + (n / 1e12).toFixed(2) + 'T';
    else if (abs >= 1e9) formatted = prefix + (n / 1e9).toFixed(2) + 'B';
    else if (abs >= 1e6) formatted = prefix + (n / 1e6).toFixed(2) + 'M';
    else if (abs >= 1e3) formatted = prefix + n.toLocaleString('en-US');
    else formatted = prefix + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    return esc(formatted);
  }

  if (unit === 'shares' || unit === 'pure') {
    const abs = Math.abs(n);
    if (abs >= 1e9) return esc((n / 1e9).toFixed(2) + 'B');
    if (abs >= 1e6) return esc((n / 1e6).toFixed(2) + 'M');
    return esc(n.toLocaleString('en-US'));
  }

  return esc(n.toLocaleString('en-US'));
}

function fpBadge(fp) {
  if (!fp) return '';
  const cls = fp === 'FY' ? 'badge-amber' : 'badge-dim';
  return `<span class="badge ${cls}">${esc(fp)}</span>`;
}

// ── PAGINATION ─────────────────────────────────────────────────
function renderPagination(total, currentPage, onPage) {
  const el = document.getElementById('pagination');
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));

  if (totalPages <= 1) {
    el.style.display = 'none';
    return;
  }

  el.style.display = 'flex';

  // Build page range
  let pages = [];
  const maxShow = 7;
  if (totalPages <= maxShow) {
    for (let i = 0; i < totalPages; i++) pages.push(i);
  } else {
    pages.push(0);
    let start = Math.max(1, currentPage - 2);
    let end = Math.min(totalPages - 2, currentPage + 2);
    if (start > 1) pages.push(-1); // ellipsis
    for (let i = start; i <= end; i++) pages.push(i);
    if (end < totalPages - 2) pages.push(-1);
    pages.push(totalPages - 1);
  }

  el.innerHTML = `
    <button class="page-btn" ${currentPage === 0 ? 'disabled' : ''} data-p="${currentPage - 1}">&lt;</button>
    ${pages.map(p => p === -1
      ? '<span class="page-info">...</span>'
      : `<button class="page-btn ${p === currentPage ? 'active' : ''}" data-p="${p}">${p + 1}</button>`
    ).join('')}
    <button class="page-btn" ${currentPage >= totalPages - 1 ? 'disabled' : ''} data-p="${currentPage + 1}">&gt;</button>
    <span class="page-info">${(currentPage * PAGE_SIZE + 1)}–${Math.min((currentPage + 1) * PAGE_SIZE, total)} of ${total.toLocaleString()}</span>
  `;

  el.querySelectorAll('.page-btn:not(:disabled)').forEach(btn => {
    btn.addEventListener('click', () => {
      const p = parseInt(btn.dataset.p);
      if (p >= 0 && p < totalPages) onPage(p);
    });
  });
}

// ── UTIL ───────────────────────────────────────────────────────
function esc(s) {
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

// ── GO ─────────────────────────────────────────────────────────
init();
</script>
</body>
</html>
